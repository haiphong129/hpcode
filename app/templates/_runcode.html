<form  method = "POST" id="submit-form" enctype="multipart/form-data">
    <div class="row m-1 p-1 justify-content-center">
                <div class="col-auto m-1 p-1 ">
                    <select class="form-select" onchange="changeLang()" id="langtmp" >
                        {% for key in config['LANG'] %}
                            <option value="{{key}}">{{config['LANG'][key]}}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-auto m-1 p-1">    
                    <select class="form-select" onchange="changeSize()" id="fontsize">
                        <option value=17>17</option>
                            {% for i in range(15,25,1) %} <option value={{i}}>{{i}}</option>{% endfor %}
                    </select>
                </div>
                <div class="col-auto m-1 p-1">
                    <select class="form-select" onchange="changeTheme()" id="theme">
                        {% for theme in config['THEME'] %}
                            <option value="{{theme}}">{{theme}}</option>
                        {% endfor %}
                    </select>
                </div>
                
    </div>

    <input type="hidden" name="ccode" id="ccode" >
    <input type="hidden" name="idp" id="idp" value="{{problem['id_p']}}" >
    <input type="hidden" name="lang" id="lang" value="{{problem['ext']}}"><!-- Ngôn ngữ -->
    <div class="row justify-content-center d-flex">
        <div class="col-sm m-1 p-1 text-center" id="changelanguae">
            {% if problem['ext'] == 'sb3'%}
                <input type="file" name="filesb3" id="filesb3" class="form-control form-control-lg" style="width: 70%;">
            {% else %}
                <textarea id="editor" class="form-control" >{{problem['tmpcode']}}</textarea>
            {%endif%}
                    
        </div>
    </div>
    <div class="row justify-content-center">
                        <div class="col-sm-3 d-grid gap-2">
                            <input type="button" name="submit" id="submit" class="btn btn-sm btn-success" value="Submit Code ({{problem['numsub']['slsub']}}/{{problem['numsub']['maxsub']}})" onclick="submitForm('submitcode');"> 
                        </div>
                        <div class="col-sm-5 m-0 p-0 text-success h6 text-center" id="countx">Lượt xem/tải test miễn phí còn lại: {{countx}}</div>
                        <div class="col-sm-3 d-grid gap-2">
                            <input type="button" name="runcode" id="runcode" class="btn btn-sm btn-primary" value="Run Code" onclick="submitForm('runcode');">
                        </div>
    </div>
    <div class="row justify-content-center d-flex">
                    <div class="form-floating m-1 p-1 hpresult">
                        <textarea class="form-control" id="testin" name="testin" style="height: 120px">{{request.form.testin}}</textarea>
                        <label for="testin"><b>Input</b></label>
                    </div>
    </div>            
    <p class="m-1 p-1"><strong>Output</strong></p>
    <div class="text-primary m-0 p-0  result col-sm" id="result">Chưa nộp bài</div>
                
    
</form>

<script src="/static/ace-builds-master/src-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
<script>   
    if ( window.history.replaceState ) { window.history.replaceState( null, null, window.location.href ); }
    
    function setdesign(editor)
        {
            editor.setTheme("ace/theme/twilight");
            editor.setFontSize(parseInt(document.getElementById("fontsize").value));
            editor.setAutoScrollEditorIntoView(true);
            editor.setOption("maxLines", 80);
            editor.setOption("minLines", 10);
        }
    var editor = ace.edit("editor");
    setdesign(editor)
    
    editor.session.setMode("ace/mode/{{problem['ext']}}");
    
    document.getElementById("langtmp").value="{{problem['ext']}}";
      
    function changeLang()  { 
        
        if( document.getElementById("langtmp").value=='scratch') 
        {
            document.getElementById("changelanguae").innerHTML = "<p align='center'><input type='file' name='filesb3' id='filesb3' class='form-control form-control-lg' style='width: 70%;'></p>";
            document.getElementById("runcode").disabled = true;
        }
        else 
        {
            document.getElementById("runcode").disabled = false;
            document.getElementById("changelanguae").innerHTML= "<textarea id='editor' class='form-control' ></textarea>";
            editor = ace.edit("editor");
            editor.session.setMode("ace/mode/"+document.getElementById("langtmp").value);
            setdesign(editor);           
        }  
        
    }
    function changeTheme() { editor.setTheme("ace/theme/"+document.getElementById("theme").value); }
    function changeSize()  { editor.setFontSize(parseInt(document.getElementById("fontsize").value));}
    
</script>

<script type="text/javascript">
    if({{problem['numsub']['slsub']}}>={{problem['numsub']['maxsub']}})document.getElementById("submit").disabled = true;
    function submitForm(urlx)
    {
        $('html, body').animate({ scrollTop: $('.hpresult').offset().top }, 100);
        if(urlx=="submitcode") {
            document.getElementById("submit").disabled = true;
            document.getElementById("result").innerHTML = "Đã nộp bài...";
        }
        document.getElementById("ccode").value = editor.getSession().getValue();
        document.getElementById("lang").value = document.getElementById("langtmp").value;
        console.log(document.getElementById("lang").value);
        var directx;
        if(urlx=="runcode") {directx = "{{ url_for('runcode')}}"};
        if(urlx=="submitcode") {directx = "{{ url_for('submitcode')}}"};
        
        var formData = new FormData();
        if(document.getElementById("langtmp").value=='scratch')
        {
            var input = document.getElementById("filesb3");
            var files = input.files;
            for (var i = 0; i !== files.length; i++) { formData.append("filesb3", files[i]);  }
        }
        else formData.append("ccode", $("#ccode").val());
        
        formData.append("lang", $("#lang").val());
        formData.append("testin",$("#testin").val());
        formData.append("idp",$("#idp").val());
        $.ajax({
            type:'POST',
            url:directx,
            processData: false,
            contentType: false,
            data: formData,
        
        success:function(data)
        {
            var countlimit=500,refreshId = setInterval(function() {
                var flog='/static/chambai/tmp/'+data['idlog'];
                var y=$.getScript(flog);
                    y.done(function(data) { 

                        var dt=data.replaceAll("\n", "<br>");
                        document.getElementById("result").innerHTML = dt.toString();
                        countlimit--;
                        console.log(countlimit);
                        if(countlimit<=0)  clearInterval(refreshId);
                        if(dt.indexOf("xong")>-1)  clearInterval(refreshId);
                        
                    });
                    
                    y.fail(function(data) { 
                        document.getElementById("result").innerHTML = "Chưa nộp bài";
                    });
            },1000);

            if(urlx=="submitcode") {
                document.getElementById("submit").disabled = true;
                document.getElementById("submit").value = "Submit Code ("+data['slsub'].toString()+"/"+data['maxsub'].toString()+")";
            var count = 30, timer = setInterval(function() {
                document.getElementById("submit").value = "Submit Code ("+count.toString()+"s)"
                count--;
                if(count == 1) 
                {
                    if(data['slsub']<data['maxsub']) document.getElementById("submit").disabled = false;
                    document.getElementById("submit").value = "Submit Code ("+data['slsub'].toString()+"/"+data['maxsub'].toString()+")";
                    clearInterval(timer);
                }
            }, 1000);
            document.getElementById("countx").innerHTML = "Lượt xem/tải tests miễn phí còn lại: <b>"+data['countx']+"</b>";
        }
        }
      })
    }
  </script>

